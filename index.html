<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>HALO Drift Calculator ‚Äì Multi-Layer Wind</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h2 {
      text-align: center;
      color: #222;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .layer-header, .layer-row {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1.2fr 1.2fr 0.5fr;
      gap: 10px;
      align-items: center;
    }
    .layer-header {
      font-weight: bold;
      margin-bottom: -5px;
      padding-right: 12px;
    }
    .layer-header > div {
      text-align: left;
    }
    .layer-row {
      margin-top: 10px;
      padding-right: 12px;
    }
    .layer-row input {
      width: 100%;
      min-width: 0;
      padding: 8px 6px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .remove-btn {
      background-color: #dc3545;
      color: white;
      padding: 8px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }
    .remove-btn:hover {
      background-color: #c82333;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      padding: 12px;
      width: 100%;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .result {
      margin-top: 15px;
      font-size: 16px;
      line-height: 1.6;
    }
    .plot-container {
      margin-top: 30px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    #drift-plot {
      max-width: 400px;
      max-height: 400px;
    }
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>HALO Drift Calculator ‚Äì Multi-Layer Wind</h2>

  <div class="section">
    <h3>Wind Layers</h3>
    <div class="layer-header">
      <div>Top Alt (ft)</div>
      <div>Bottom Alt (ft)</div>
      <div>Wind Dir (¬∞)</div>
      <div>Wind Speed (kt)</div>
      <div></div>
    </div>
    <div id="wind-layers"></div>
    <button type="button" onclick="addLayer()">+ Add Wind Layer</button>
  </div>

  <div class="section">
    <h3>Freefall & Canopy Drift</h3>
    <button type="button" onclick="calcDrift()">Calculate Drift Vectors & Displacement</button>
    <div class="result" id="drift-result">Result will appear here...</div>
    <div class="plot-container">
      <canvas id="drift-plot" width="400" height="400"></canvas>
    </div>
  </div>

  <div class="section">
    <h3>Forward Throw (FT)</h3>
    <label for="dq">Deceleration Quotient (DQ)</label>
    <select id="dq">
      <option value="2.5">5000 FT = 2.5</option>
      <option value="2.7">10000 FT = 2.7</option>
      <option value="2.8">15000 FT = 2.8</option>
      <option value="3.0">20000 FT = 3.0</option>
    </select>

    <label for="gs-ft">Ground Speed (knots)</label>
    <input type="number" id="gs-ft" placeholder="e.g. 130">

    <button type="button" onclick="calcFT()">Calculate FT</button>
    <div class="result" id="ft-result"></div>
  </div>

  <div class="section">
    <h3>Dispersion (DIS)</h3>
    <label for="gs-dis">Ground Speed (knots)</label>
    <input type="number" id="gs-dis" placeholder="e.g. 130">

    <label for="time">Time Between Jumpers (sec)</label>
    <input type="number" id="time" placeholder="e.g. 5">

    <button type="button" onclick="calcDIS()">Calculate DIS</button>
    <div class="result" id="dis-result"></div>
  </div>

  <script>
    let driftChart;

    function addLayer() {
      const container = document.getElementById("wind-layers");
      const div = document.createElement("div");
      div.classList.add("layer-row");
      div.innerHTML = `
        <input type="number" placeholder="Top Alt (ft)">
        <input type="number" placeholder="Bottom Alt (ft)">
        <input type="number" placeholder="Wind Dir (¬∞)">
        <input type="number" placeholder="Wind Speed (kt)">
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">‚úï</button>
      `;
      container.appendChild(div);
    }

    function degToRad(deg) {
      return deg * Math.PI / 180;
    }

    function calcVector(K) {
      const rows = document.getElementById("wind-layers").children;
      let sumDx = 0, sumDy = 0;
      for (let row of rows) {
        const inputs = row.querySelectorAll("input");
        const topAlt = parseFloat(inputs[0].value);
        const botAlt = parseFloat(inputs[1].value);
        const dir = parseFloat(inputs[2].value);
        const spd = parseFloat(inputs[3].value);

        if (isNaN(topAlt) || isNaN(botAlt) || isNaN(dir) || isNaN(spd)) continue;

        const dAlt = (topAlt - botAlt) / 1000;
        const angle = (dir + 180) % 360;
        const rad = degToRad(angle);
        const vx = spd * Math.sin(rad);
        const vy = spd * Math.cos(rad);

        sumDx += K * dAlt * vx;
        sumDy += K * dAlt * vy;
      }
      const total = Math.sqrt(sumDx**2 + sumDy**2);
      const bearing = (Math.atan2(sumDx, sumDy) * 180 / Math.PI + 360) % 360;

      return {
        dx: sumDx,
        dy: sumDy,
        dxR: sumDx.toFixed(2),
        dyR: sumDy.toFixed(2),
        total: total.toFixed(2),
        bearing: bearing.toFixed(1)
      };
    }

    function calcDrift() {
      const ffd = calcVector(3);
      const cd = calcVector(30);

      document.getElementById("drift-result").innerHTML = `
        <b>Freefall Drift (K=3):</b><br>
        üí® X: ${ffd.dxR} m | Y: ${ffd.dyR} m<br>
        üìè Distance: ${ffd.total} m<br>
        üß≠ Bearing: ${ffd.bearing}¬∞<br><br>
        <b>Canopy Drift (K=30):</b><br>
        ü™Ç X: ${cd.dxR} m | Y: ${cd.dyR} m<br>
        üìè Distance: ${cd.total} m<br>
        üß≠ Bearing: ${cd.bearing}¬∞
      `;

      plotDrift(ffd, cd);
    }

    function plotDrift(ffd, cd) {
      const ctx = document.getElementById('drift-plot').getContext('2d');

      // Find the maximum extent for chart scaling
      const max = Math.max(
        Math.abs(ffd.dx), Math.abs(ffd.dy),
        Math.abs(cd.dx), Math.abs(cd.dy), 10
      );

      // Datasets for Freefall and Canopy
      const data = {
        labels: ['Origin', 'Freefall', 'Canopy'],
        datasets: [
          // Freefall vector (blue)
          {
            label: 'Freefall Drift',
            data: [
              {x: 0, y: 0},
              {x: ffd.dx, y: ffd.dy}
            ],
            borderColor: 'blue',
            backgroundColor: 'blue',
            pointRadius: [5, 5],
            fill: false,
            showLine: true,
            tension: 0,
          },
          // Canopy vector (green)
          {
            label: 'Canopy Drift',
            data: [
              {x: 0, y: 0},
              {x: cd.dx, y: cd.dy}
            ],
            borderColor: 'green',
            backgroundColor: 'green',
            pointRadius: [5, 5],
            fill: false,
            showLine: true,
            tension: 0,
          }
        ]
      };

      const options = {
        responsive: false,
        scales: {
          x: {
            min: -max,
            max: max,
            title: {
              display: true,
              text: 'X (meters)'
            },
            grid: { color: '#eee' }
          },
          y: {
            min: -max,
            max: max,
            title: {
              display: true,
              text: 'Y (meters)'
            },
            grid: { color: '#eee' }
          }
        },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { enabled: true }
        }
      };

      // Destroy old chart if exists
      if (driftChart) {
        driftChart.destroy();
      }
      driftChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: options
      });
    }

    function calcFT() {
      const dq = parseFloat(document.getElementById("dq").value);
      const gs = parseFloat(document.getElementById("gs-ft").value);
      if (isNaN(dq) || isNaN(gs)) {
        document.getElementById("ft-result").innerText = "‚ùå Invalid input";
        return;
      }
      const ft = dq * gs * 0.51;
      document.getElementById("ft-result").innerText = `üõ´ FT = ${ft.toFixed(2)} meters`;
    }

    function calcDIS() {
      const gs = parseFloat(document.getElementById("gs-dis").value);
      const t = parseFloat(document.getElementById("time").value);
      if (isNaN(gs) || isNaN(t)) {
        document.getElementById("dis-result").innerText = "‚ùå Invalid input";
        return;
      }
      const dis = gs * t * 0.51;
      document.getElementById("dis-result").innerText = `üë• DIS = ${dis.toFixed(2)} meters`;
    }

    // Add one default layer for user convenience
    addLayer();
  </script>
</body>
</html>
